import{fieldValidation,initializeInlineFieldValidation,handleScrollAndFocusOnError,handleCaptchaValidation,srfmFields}from"./validation";import{applyFilters}from"@wordpress/hooks";import{__}from"@wordpress/i18n";function initializeFormHandlers(){initializeInlineFieldValidation();for(let v of Array.from(document.querySelectorAll(".srfm-form"))){document.dispatchEvent(new CustomEvent("srfm_form_before_submission",{detail:{form:v}}));let{formId:t,submitType:s,successUrl:o,ajaxUrl:a,nonce:i,loader:n,successContainer:c,successElement:l,recaptchaType:m,afterSubmission:u,captchaErrorElement:d,hCaptchaDiv:f,turnstileDiv:b,hasLoginBlock:p}=extractFormAttributesAndElements(v),h="v2-checkbox"===m||!!f||!!b;v.addEventListener("submit",async e=>{e.preventDefault();e=e.target;if("FORM"===e?.tagName){var r=(e?.closest(".srfm-form-container"))?.classList.contains("srfm-submit-button-hidden"),e=e?.querySelector("button.srfm-custom-button");if(r&&!e)return void console.warn("Form submission is disabled because the submit button is hidden.")}p&&!v.__loginSuccess?(r=new CustomEvent("srfm_login_request",{cancelable:!0,detail:{form:v}}),v.dispatchEvent(r)):(handleFormSubmission(v,t,a,i,n,o,c,l,s,u,h?m:void 0,h?f:void 0,h?b:void 0,h?d:void 0),v.__loginSuccess=!0)})}}function prepareAddressesData(e){e=e.querySelectorAll(".srfm-address-block");if(!e)return null;let t={};return e.forEach(e=>{var r=e.getAttribute("data-slug");r&&(e=e.querySelectorAll(".srfm-input-input, .srfm-dropdown-input"),e=Array.from(e).map(e=>e?.value?.trim()).filter(Boolean).join(", "),t[r]=e)}),0<Object.keys(t).length?t:null}async function submitFormData(e){var r=new FormData(e);let t=new FormData;var s,o,a=["srfm-email-confirm","srfm-password-confirm"];for([s,o]of r.entries())a.includes(s)||(""!==o&&((e.querySelector(`[name="${s}"]`)?.closest(".srfm-block-single"))?.classList.contains("hide-element")&&(o=""),o=applyFilters("srfm.filterFieldValue",o,{key:s,form:e})),applyFilters("srfm.shouldSkipField",!1,{key:s,value:o,form:e}))||t.append(s,o);r=prepareAddressesData(e);r&&t.append("srfm_addresses",JSON.stringify(r));let i=applyFilters("srfm.prepareAdditionalFormData",{},e);Object.keys(i).forEach(e=>{null!=i[e]&&t.append(e,JSON.stringify(i[e]))});try{return await wp.apiFetch({path:"sureforms/v1/submit-form",method:"POST",body:t})}catch(e){console.log(e)}}async function afterSubmit(e){e=e.data.submission_id;try{await wp.apiFetch({path:"/sureforms/v1/after-submission/"+e,method:"GET"})}catch(e){console.error(e)}}function showSuccessMessage(e,r,t,s,o,a,i){a=new CustomEvent("srfm_on_show_success_message",{cancelable:!0,detail:{form:s,element:r,message:t,submitType:a,container:e,loader:i}});document.dispatchEvent(a)&&(enableSubmitButton(s),"hide form"===o?(s.style.opacity=1,s.style.display="none",setTimeout(()=>{r.style.opacity=1},500)):"reset form"===o&&s.reset(),r.innerHTML=t,e.classList.add("srfm-active"),window?.srfm?.handleInstantFormWrapperHeight(),applyFilters("srfm.enableScrollOnSuccess",!0))&&s.parentElement.scrollIntoView({behavior:"smooth"})}function redirectToUrl(e){window.location.assign(e)}function dispatchErrorEvent(e){var{form:e,message:r="",position:t="footer",log_message:s=null}=e.detail||{};e&&(s&&console.warn(s),s=r||__("There was an error trying to submit your form. Please try again.","sureforms"),r=e.querySelector(".srfm-common-error-message."+("header"===t?"srfm-head-error":"srfm-footer-error")))&&(r.querySelector(".srfm-error-content").innerHTML=s,r.removeAttribute("hidden"),handleScrollAndFocusOnError({firstErrorInput:r,scrollElement:r}))}function showErrorMessage(e){var{form:e,message:r="",position:t="footer",log_message:s=null}=e,e=new CustomEvent("srfm_show_common_form_error",{detail:{form:e,message:r,position:t,log_message:s}});document.dispatchEvent(e)}function hideErrorMessage(e){e.querySelectorAll(".srfm-common-error-message").forEach(e=>{e.setAttribute("hidden","")})}function enableSubmitButton(e){e=e.querySelector('#srfm-submit-btn, button[type="submit"], .srfm-custom-button');e&&(e.disabled=!1,e.style.pointerEvents="")}async function handleFormSubmission(r,t,e,s,o,a,i,n,c,l,m,u,d,f){try{o.classList.add("srfm-active");var b,p,h=r.querySelector('#srfm-submit-btn, button[type="submit"], .srfm-custom-button'),v=(h&&(h.disabled=!0,h.style.pointerEvents="none"),hideErrorMessage(r),await fieldValidation(t,e,s,r)),y=handleCaptchaValidation(m,u,d,f);v?.validateResult||!y?(o.classList.remove("srfm-active"),enableSubmitButton(r),v?.validateResult?handleScrollAndFocusOnError(v):y||handleScrollAndFocusOnError({firstErrorInput:f,scrollElement:f})):(b=new CustomEvent("srfm_on_trigger_form_submission",{cancelable:!0,detail:{form:r,loader:o,formId:t,submitType:c,successElement:n,successContainer:i}}),document.dispatchEvent(b)?(p=await submitFormData(r))?.success?(emitFormSubmitSuccess({...p,formId:t}),"same page"===c?(showSuccessMessage(i,n,p?.message??"",r,l,c),o.classList.remove("srfm-active"),enableSubmitButton(r)):["different page","custom url"].includes(c)?(p?.redirect_url&&redirectToUrl(p?.redirect_url),o.classList.remove("srfm-active"),enableSubmitButton(r)):showSuccessMessage(i,n,p?.message??"",r,l,c,o),p?.data?.after_submit&&afterSubmit(p)):(showErrorMessage({form:r,...p?.data||{}}),o.classList.remove("srfm-active"),enableSubmitButton(r)):(o.classList.remove("srfm-active"),enableSubmitButton(r)))}catch(e){h=new CustomEvent("srfm_on_trigger_form_submission_failure",{detail:{form:r,error:e,loader:o,formId:t,submitType:c,successElement:n,successContainer:i}});document.dispatchEvent(h),o.classList.remove("srfm-active"),enableSubmitButton(r),showErrorMessage({form:r})}}function extractFormAttributesAndElements(e){var r=e.getAttribute("form-id"),t=e.getAttribute("message-type"),s=e.getAttribute("success-url"),o=e.getAttribute("ajaxurl"),a=e.getAttribute("data-nonce"),i=e.querySelector(".srfm-loader"),n=e.parentElement.querySelector(".srfm-single-form.srfm-success-box"),c=n?.querySelector(".srfm-success-box-description"),l=e.querySelector("#srfm-submit-btn"),m=e.getAttribute("after-submission"),u=e.querySelector(".g-recaptcha");return{formId:r,submitType:t,successUrl:s,ajaxUrl:o,nonce:a,loader:i,successContainer:n,successElement:c,submitBtn:l,siteKey:u?.getAttribute("data-sitekey"),recaptchaType:u?.getAttribute("recaptcha-type"),afterSubmission:m,captchaErrorElement:e.querySelector("#captcha-error"),hCaptchaDiv:e.querySelector(".h-captcha"),turnstileDiv:e.querySelector(".cf-turnstile"),hasLoginBlock:e.querySelector(".srfm-login-block")}}function recaptchaCallback(b=""){Array.from(document.querySelectorAll(".srfm-form")).forEach(e=>{let{formId:r,submitType:t,successUrl:s,ajaxUrl:o,nonce:a,loader:i,successContainer:n,successElement:c,submitBtn:l,siteKey:m,recaptchaType:u,afterSubmission:d}=extractFormAttributesAndElements(e),f=!1;"v2-invisible"===u&&(grecaptcha.render(l,{sitekey:m,callback:()=>{handleFormSubmission(e,r,o,a,i,s,n,c,t,d),f=!0},"error-callback":()=>{showErrorMessageOnRecaptchaError({containerSelector:'.g-recaptcha[recaptcha-type="v2-invisible"]:not(.captcha-error-added)',message:srfm_submit?.messages?.srfm_google_captcha_error_message})}}),l.addEventListener("click",()=>{i.classList.add("srfm-active"),f&&handleFormSubmission(e,r,o,a,i,s,n,c,t,d)})),"v3-reCAPTCHA"===u&&b&&(i.classList.add("srfm-active"),handleFormSubmission(e,r,o,a,i,s,n,c,t,d))})}function showErrorMessageOnRecaptchaError(e){let{containerSelector:r,message:t=""}=e;e=document.querySelectorAll(r);e&&e.forEach(e=>{var r=e.closest(".srfm-form");r&&(showErrorMessage({form:r,message:t}),e.classList.add("captcha-error-added"))})}function emitFormSubmitSuccess(e){e=new CustomEvent("srfm_form_submission_success",{detail:{formId:"srfm-form-"+e.formId}});document.dispatchEvent(e)}document.addEventListener("srfm_initialize_validation",e=>{var e=e?.detail?.fields;e&&Array.isArray(e)?(e=e.filter(e=>srfmFields().includes(e)),initializeInlineFieldValidation(e)):initializeInlineFieldValidation()}),document.addEventListener("DOMContentLoaded",function(){initializeFormHandlers()}),document.addEventListener("srfm_show_common_form_error",dispatchErrorEvent),window.recaptchaCallback=recaptchaCallback,window.handleBricksPreviewFormSubmission=function(){var e;for(e of Array.from(document.querySelectorAll(".srfm-form")))e.addEventListener("submit",async function(e){e.preventDefault()})},window.addEventListener("elementor/popup/show",function(e){e?.detail?.instance?.$element?.[0]?.querySelector(".srfm-form-container")&&initializeFormHandlers()}),document.addEventListener("srfm_form_initialize",function(){initializeFormHandlers()});